<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>iPad WhatsApp 3D con escribiendo...</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
  </style>
</head>
<body>
<canvas id="chatCanvas" width="1024" height="2048" style="display:none;"></canvas>

<!-- üé∂ M√∫sica cargada desde jsDelivr -->
<audio id="bgMusic" src="https://cdn.jsdelivr.net/gh/gonzalezwerner/teamomivida@main/portuamormivida.mp3" loop></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<script>
let scene, camera, renderer, controls, phone, chatTexture, ctx;
let shownMessages = [];
let messages = [
  { text: "Lo sientoüòî, s√© que no soy", from: "me" },
  { text: "perfecto. üíî", from: "other" },
  { text: "Pero te amo ‚ù§Ô∏è", from: "other" },
  { text: "Quiero arreglarlo ‚ù§Ô∏è", from: "me" },
  { text: "Quiero estar bien contigo ü•∫", from: "other" },
  { text: "Por favor mi vida üíï", from: "me" },
  { text: "Te amo üòç", from: "other" },
  { text: "Princesa hermosa üòç", from: "other" }
];
let currentMsg = -1;
let ipadOn = false;
const audio = document.getElementById("bgMusic");

// üå∏ Corazones
let hearts = [];

init();
animate();

// ================= INIT =================
function init(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // OrbitControls solo para zoom manual con dedos
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableRotate = false; 
  controls.enableZoom = true;
  controls.enablePan = true;
  controls.zoomSpeed = 1.2;
  controls.minDistance = 5;  
  controls.maxDistance = 20;  

  const chatCanvas = document.getElementById("chatCanvas");
  ctx = chatCanvas.getContext("2d");
  chatTexture = new THREE.CanvasTexture(chatCanvas);
  chatTexture.anisotropy = renderer.capabilities.getMaxAnisotropy();

  // Pantalla apagada al inicio
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,chatCanvas.width,chatCanvas.height);
  chatTexture.needsUpdate = true;

  // Cargar modelo iPad
  const loader = new THREE.GLTFLoader();
  loader.load("ipad.glb",(gltf)=>{
    phone = gltf.scene;
    phone.scale.set(0.7,0.7,0.7);
    scene.add(phone);
    centerAndFit(phone);

    phone.traverse((child)=>{
      if(child.isMesh){
        if(child.name === "screen_screen_0"){
          child.material = new THREE.MeshBasicMaterial({ map: chatTexture });
        }
        else if(
          child.name === "Apple001_logo_0" ||
          child.name.includes("camera") ||
          child.name.includes("flash") ||
          child.name.includes("sensor") ||
          child.name.includes("mic")
        ){
          return;
        } else {
          child.material = new THREE.MeshStandardMaterial({
            color: 0x555555,
            metalness: 0.6,
            roughness: 0.4
          });
        }
      }
    });

    window.addEventListener("click", onIpadClick);
  });

  const light = new THREE.PointLight(0xffffff, 1.2);
  light.position.set(10,10,10);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff,0.6));

  activarGiroscopio();

  // ‚ù§Ô∏è Crear corazones cada 300ms
  setInterval(()=>{
    let heart = createHeart3D();
    heart.position.set((Math.random()-0.5)*10, 8, (Math.random()-0.5)*6);
    scene.add(heart);
    hearts.push(heart);
  },300);
}

// ================= GIROSCOPIO =================
function activarGiroscopio(){
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          window.addEventListener("deviceorientation", handleOrientation, true);
        }
      })
      .catch(console.error);
  } else {
    window.addEventListener("deviceorientation", handleOrientation, true);
  }
}

function handleOrientation(event){
  if(!phone) return;
  let gamma = event.gamma || 0; 
  let beta = event.beta || 0;   

  phone.rotation.y = THREE.MathUtils.degToRad(gamma * 1.5);
  phone.rotation.x = THREE.MathUtils.degToRad(beta * 0.6);
}

// ================= CLICK =================
function onIpadClick(event){
  if(!phone) return;
  let mouse = new THREE.Vector2(
    (event.clientX / window.innerWidth) * 2 - 1,
    -(event.clientY / window.innerHeight) * 2 + 1
  );
  let raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);
  let intersects = raycaster.intersectObject(phone, true);

  if(intersects.length > 0 && !ipadOn){
    ipadOn = true;
    audio.play();
    shownMessages = [];
    currentMsg = -1;
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,1024,2048);
    drawHeader();
    nextMessage();
  }
}

// ================= AJUSTAR C√ÅMARA =================
function centerAndFit(object){
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  object.position.sub(center);
  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI/180);
  let cameraZ = Math.abs(maxDim / Math.tan(fov/2)) * 1.8;
  camera.position.set(0, size.y*0.5, cameraZ);
  camera.lookAt(0,0,0);
}

// ================= LOOP =================
function animate(){
  requestAnimationFrame(animate);

  // Animar corazones
  hearts.forEach((h,i)=>{
    h.position.y -= 0.03;
    h.rotation.y += 0.04;
    if(h.position.y < -5){
      scene.remove(h);
      hearts.splice(i,1);
    }
  });

  controls.update();
  renderer.render(scene,camera);
}

// ================= CHAT =================
function drawHeader(){
  ctx.fillStyle = "#075E54";
  ctx.fillRect(0,0,1024,200);
  ctx.fillStyle = "#fff";
  ctx.font = "bold 80px Arial";
  ctx.fillText("Princesa üíï", 40, 100);
  chatTexture.needsUpdate = true;
}

function nextMessage(){
  currentMsg++;
  if(currentMsg >= messages.length) return;
  let msg = messages[currentMsg];

  // escribiendo...
  ctx.fillStyle="#111";
  ctx.fillRect(0,200,1024,1848);
  drawHeader();
  drawMessages();
  ctx.fillStyle="#aaa";
  ctx.font="italic 50px Arial";
  ctx.fillText("Escribiendo...", 60, 240 + shownMessages.length*200);
  chatTexture.needsUpdate = true;

  setTimeout(()=>{
    ctx.fillStyle="#111";
    ctx.fillRect(0,200,1024,1848);
    drawHeader();
    shownMessages.push(msg);
    drawMessages();
    chatTexture.needsUpdate = true;
    setTimeout(nextMessage,2000);
  },1500);
}

function drawMessages(){
  shownMessages.forEach((m,i)=>{
    let y = 240 + i*200;
    ctx.font = "bold 60px Arial";
    let bubbleWidth = ctx.measureText(m.text).width + 80;
    let bubbleHeight = 160;
    let x = m.from==="me"? 1024-bubbleWidth-60 : 40;

    ctx.fillStyle = m.from==="me" ? "#25D366" : "#fff";
    roundRect(ctx, x, y, bubbleWidth, bubbleHeight, 50, true);
    ctx.fillStyle = m.from==="me" ? "#fff" : "#000";
    ctx.fillText(m.text, x+40, y+90);
  });
}

function roundRect(ctx, x, y, width, height, radius, fill){
  ctx.beginPath();
  ctx.moveTo(x+radius,y);
  ctx.lineTo(x+width-radius,y);
  ctx.quadraticCurveTo(x+width,y,x+width,y+radius);
  ctx.lineTo(x+width,y+height-radius);
  ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height);
  ctx.lineTo(x+radius,y+height);
  ctx.quadraticCurveTo(x,y+height,x,y+height-radius);
  ctx.lineTo(x,y+radius);
  ctx.quadraticCurveTo(x,y,x+radius,y);
  ctx.closePath();
  if(fill) ctx.fill();
}

// ‚ù§Ô∏è Crear coraz√≥n 3D
function createHeart3D(){
  const shape = new THREE.Shape();
  shape.moveTo(0, 0);
  shape.bezierCurveTo(0, 0, -0.5, -0.5, -1, 0);
  shape.bezierCurveTo(-2, 1, -2, 3, 0, 4);
  shape.bezierCurveTo(2, 3, 2, 1, 1, 0);
  shape.bezierCurveTo(0.5, -0.5, 0, 0, 0, 0);

  const geometry = new THREE.ExtrudeGeometry(shape, { depth:0.3, bevelEnabled:false });
  const material = new THREE.MeshPhongMaterial({ color: 0xff0000 });
  const heart = new THREE.Mesh(geometry, material);
  heart.scale.set(0.5,0.5,0.5);
  return heart;
}
</script>
</body>
</html>
