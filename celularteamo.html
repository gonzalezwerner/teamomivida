<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>iPad WhatsApp 3D con todo</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
  </style>
</head>
<body>
<canvas id="chatCanvas" width="1024" height="2048" style="display:none;"></canvas>

<!-- Música -->
<audio id="bgMusic" src="https://cdn.jsdelivr.net/gh/gonzalezwerner/teamomivida/portuamormivida.mp3" loop></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<script>
let scene, camera, renderer, controls, phone, chatTexture, ctx, listener, audioObj, ipadSpeaker;
let shownMessages = [];
let messages = [
  { text: "Lo siento😔, sé que no soy", from: "me" },
  { text: "perfecto 💔", from: "other" },
  { text: "Pero te amo ❤️", from: "other" },
  { text: "Quiero arreglarlo ❤️", from: "me" },
  { text: "Quiero estar bien contigo 🥺", from: "other" },
  { text: "Por favor mi vida 💕", from: "me" },
  { text: "Te amo 😍", from: "other" },
  { text: "Princesa hermosa 😍", from: "other" }
];
let currentMsg = -1;
let ipadOn = false;
let hearts = [];

init();
animate();

function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.enableZoom = true; // zoom con dedos

  // Sistema de audio
  listener = new THREE.AudioListener();
  camera.add(listener);
  const audioEl = document.getElementById("bgMusic");
  audioObj = new THREE.Audio(listener);
  const mediaElement = new Audio(audioEl.src);
  mediaElement.loop = true;
  mediaElement.crossOrigin = "anonymous";
  const mediaElementSource = listener.context.createMediaElementSource(mediaElement);
  mediaElementSource.connect(listener.context.destination);
  audioObj.setMediaElementSource(mediaElement);

  // Canvas del chat
  const chatCanvas = document.getElementById("chatCanvas");
  ctx = chatCanvas.getContext("2d");
  chatTexture = new THREE.CanvasTexture(chatCanvas);

  // Pantalla apagada
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,chatCanvas.width,chatCanvas.height);
  chatTexture.needsUpdate = true;

  // Cargar iPad
  const loader = new THREE.GLTFLoader();
  loader.load("ipad.glb",(gltf)=>{
    phone = gltf.scene;
    phone.scale.set(0.7,0.7,0.7);
    scene.add(phone);
    centerAndFit(phone);

    // Agregar música como audio posicional desde el iPad
    ipadSpeaker = new THREE.PositionalAudio(listener);
    phone.add(ipadSpeaker);
    ipadSpeaker.setMediaElementSource(mediaElement);
    ipadSpeaker.setRefDistance(2);

    phone.traverse((child)=>{
      if(child.isMesh){
        if(child.name === "screen_screen_0"){
          child.material = new THREE.MeshBasicMaterial({ map: chatTexture });
        }
      }
    });

    window.addEventListener("click", onIpadClick);
  });

  // Luces
  const light = new THREE.PointLight(0xffffff, 1.2);
  light.position.set(10,10,10);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff,0.6));

  // Corazones cayendo
  setInterval(()=>{
    if(!phone) return;
    let heart = createHeart3D();
    heart.position.set((Math.random()-0.5)*15, 10, (Math.random()-0.5)*10);
    scene.add(heart);
    hearts.push(heart);
  },200);

  // Giroscopio
  if(window.DeviceOrientationEvent){
    window.addEventListener("deviceorientation", handleOrientation);
  }

  window.addEventListener("resize", onResize);
}

function onIpadClick(event){
  if(!phone || ipadOn) return;

  // Detectar click en pantalla
  let mouse = new THREE.Vector2(
    (event.clientX / window.innerWidth) * 2 - 1,
    -(event.clientY / window.innerHeight) * 2 + 1
  );
  let raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);
  let intersects = raycaster.intersectObject(phone, true);

  if(intersects.length > 0 && !ipadOn){
    ipadOn = true;
    ipadSpeaker.play();
    shownMessages = [];
    currentMsg = -1;
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,1024,2048);
    drawHeader();
    nextMessage();
  }
}

function handleOrientation(event){
  if(!phone) return;
  let beta = event.beta || 0;   // inclinación adelante/atrás
  let gamma = event.gamma || 0; // inclinación izquierda/derecha

  phone.rotation.x = beta * (Math.PI/180) * 0.3;
  phone.rotation.y = gamma * (Math.PI/180) * 0.3;
}

function centerAndFit(object){
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  object.position.sub(center);
  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI/180);
  let cameraZ = Math.abs(maxDim / Math.tan(fov/2));
  camera.position.set(0, size.y*0.5, cameraZ * 2);
  camera.lookAt(0,0,0);
}

function animate(){
  requestAnimationFrame(animate);

  // Corazones cayendo
  hearts.forEach((h,i)=>{
    h.position.y -= 0.05;
    h.rotation.y += 0.05;
    if(h.position.y < -5){
      scene.remove(h);
      hearts.splice(i,1);
    }
  });

  controls.update();
  renderer.render(scene,camera);
}

// ================= CHAT =================
function drawHeader(){
  ctx.fillStyle = "#075E54";
  ctx.fillRect(0,0,1024,200);
  ctx.fillStyle = "#fff";
  ctx.font = "bold 80px Arial";
  ctx.fillText("Princesa 💕", 40, 100);
  chatTexture.needsUpdate = true;
}

function nextMessage(){
  currentMsg++;
  if(currentMsg >= messages.length) return;
  let msg = messages[currentMsg];

  // indicador escribiendo...
  drawAll();
  ctx.fillStyle="#aaa";
  ctx.font="italic 50px Arial";
  ctx.fillText("Escribiendo...", 60, 240 + shownMessages.length*200);
  chatTexture.needsUpdate = true;

  setTimeout(()=>{
    shownMessages.push(msg);
    drawAll();
    chatTexture.needsUpdate = true;
    setTimeout(nextMessage,2000);
  },1500);
}

function drawAll(){
  ctx.fillStyle="#111";
  ctx.fillRect(0,200,1024,1848);
  drawHeader();
  shownMessages.forEach((m,i)=>{
    let y = 240 + i*200;
    ctx.font = "bold 60px Arial";
    let bubbleWidth = ctx.measureText(m.text).width + 80;
    let bubbleHeight = 160;
    let x = m.from==="me"? 1024-bubbleWidth-60 : 40;
    ctx.fillStyle = m.from==="me" ? "#25D366" : "#fff";
    roundRect(ctx, x, y, bubbleWidth, bubbleHeight, 50, true);
    ctx.fillStyle = m.from==="me" ? "#fff" : "#000";
    ctx.fillText(m.text, x+40, y+90);
  });
}

function roundRect(ctx, x, y, width, height, radius, fill){
  ctx.beginPath();
  ctx.moveTo(x+radius,y);
  ctx.lineTo(x+width-radius,y);
  ctx.quadraticCurveTo(x+width,y,x+width,y+radius);
  ctx.lineTo(x+width,y+height-radius);
  ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height);
  ctx.lineTo(x+radius,y+height);
  ctx.quadraticCurveTo(x,y+height,x,y+height-radius);
  ctx.lineTo(x,y+radius);
  ctx.quadraticCurveTo(x,y,x+radius,y);
  ctx.closePath();
  if(fill) ctx.fill();
}

function createHeart3D(){
  const shape = new THREE.Shape();
  shape.moveTo(5,5);
  shape.bezierCurveTo(5,5, 4,0, 0,0);
  shape.bezierCurveTo(-6,0, -6,7, -6,7);
  shape.bezierCurveTo(-6,11, -3,15.4, 5,19);
  shape.bezierCurveTo(13,15.4, 16,11, 16,7);
  shape.bezierCurveTo(16,7, 16,0, 10,0);
  shape.bezierCurveTo(7,0, 5,5, 5,5);

  const extrudeSettings = { depth:2, bevelEnabled:true, bevelSegments:2, steps:2, bevelSize:1, bevelThickness:1 };
  const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
  const material = new THREE.MeshPhongMaterial({ color: 0xff0000, shininess: 150 });
  const heart = new THREE.Mesh(geometry, material);
  heart.scale.set(0.05,0.05,0.05);
  return heart;
}
  function onResize(){
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>

